<script>
(function() {
  const profileInput = document.getElementById('my-profile-text');
  const matchBtn = document.getElementById('my-match-btn');
  const resultArea = document.getElementById('my-match-result');

  matchBtn.addEventListener('click', function() {
    const userProfileText = profileInput.value;
    if (!userProfileText) {
      alert('自己PRを入力してください。');
      return;
    }
    resultArea.textContent = 'AIが解析中...';

    fetch('/api/match/ad_hoc', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ profile_text: userProfileText }),
    })
    .then(response => {
        if (!response.ok) { // 失敗した場合（400エラーなど）
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
      renderResults(data.results || []);
    })
    .catch(error => {
      console.error('Error:', error);
      resultArea.textContent = 'エラーが発生しました。詳細はコンソールを確認してください。';
    });
  });

  // 結果をHTMLテーブルに描画する関数 (変更なし)
  function renderResults(results) {
    if (results.length === 0) {
      resultArea.textContent = 'マッチする求人が見つかりませんでした。';
      return;
    }

    let tableHTML = `<table class="table">
      <tr><th>業種</th><th>求人</th><th>スコア</th><th>マッチ理由</th></tr>`;
    
    results.forEach(res => {
      const job = res.job;
      const score = res.score;
      const color = (score >= 0.8 ? '#22c55e' : (score >= 0.5 ? '#eab308' : '#ef4444'));
      
      tableHTML += `<tr>
        <td><span class="badge">${job.sector || ''}</span></td>
        <td><b>${job.title || ''}</b><br><span class="small">${job.company || ''}</span></td>
        <td style="font-weight:700; color:${color}; font-size:1.2em;">${Math.round(score * 100)}点</td>
        <td class="small">${(res.reasons || []).join('<br>') || ''}</td>
      </tr>`;
    });

    tableHTML += '</table>';
    resultArea.innerHTML = tableHTML;
  }
})();
</script>